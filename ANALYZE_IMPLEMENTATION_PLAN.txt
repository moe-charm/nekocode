# ğŸ” NekoCode analyze ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…è¨ˆç”»æ›¸
ä½œæˆæ—¥: 2025-07-31
ç›®çš„: ã‚¯ãƒ©ã‚¹ã®è²¬å‹™åˆ†æã¨åˆ†å‰²å¯èƒ½æ€§ã‚’è©•ä¾¡ã™ã‚‹çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æä¾›

## ğŸ“Š æ¦‚è¦

æ–°ã‚³ãƒãƒ³ãƒ‰ `analyze` ã¯ã€ã‚¯ãƒ©ã‚¹ã®æ§‹é€ ã‚’åˆ†æã—ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°åˆ¤æ–­ã«å¿…è¦ãªçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹ã€‚
2æ®µéšè§£ææ–¹å¼ã‚’æ¡ç”¨ã—ã€åŸºæœ¬çµ±è¨ˆã¯é«˜é€Ÿã«ã€è©³ç´°è§£æã¯å¿…è¦æ™‚ã®ã¿å®Ÿè¡Œã€‚

## ğŸ¯ è¨­è¨ˆæ–¹é‡

### åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
```
ã‚¯ãƒ©ã‚¹ = çŠ¶æ…‹ï¼ˆå¤‰æ•°ï¼‰ Ã— æŒ¯ã‚‹èˆã„ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
è²¬å‹™ã‚¹ã‚³ã‚¢ = å¤‰æ•°æ•° Ã— ãƒ¡ã‚½ãƒƒãƒ‰æ•°
```

### 2æ®µéšè§£æ
1. **åŸºæœ¬è§£æï¼ˆé«˜é€Ÿï¼‰**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å³åº§ã«è¨ˆç®—
2. **è©³ç´°è§£æï¼ˆ--deepï¼‰**: å¤‰æ•°ä½¿ç”¨çŠ¶æ³ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ç­‰

## ğŸ“ å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### 1. ãƒ‡ãƒ¼ã‚¿æ§‹é€ æ‹¡å¼µ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `include/nekocode/types.hpp`
```cpp
// æ–°è¦è¿½åŠ 
struct MemberVariable {
    std::string name;
    std::string type;
    LineNumber declaration_line;
    bool is_static = false;
    bool is_const = false;
    std::string access_modifier = "private";  // public/private/protected
    
    // Phase2ã§è¿½åŠ ã•ã‚Œã‚‹æƒ…å ±
    std::vector<std::string> used_by_methods;
    std::vector<std::string> modified_by_methods;
};

// ClassInfoæ§‹é€ ä½“ã«è¿½åŠ 
struct ClassInfo {
    // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
    std::vector<MemberVariable> member_variables;  // æ–°è¦è¿½åŠ 
};

// çµ±è¨ˆç”¨æ§‹é€ ä½“
struct ClassMetrics {
    std::uint32_t member_variable_count = 0;
    std::uint32_t method_count = 0;
    std::uint32_t total_lines = 0;
    std::uint32_t responsibility_score = 0;  // variables Ã— methods
    float cohesion = 0.0f;  // 0.0-1.0
    std::uint32_t coupling = 0;  // å¤–éƒ¨ã‚¯ãƒ©ã‚¹å‚ç…§æ•°
};
```

### 2. ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼æ‹¡å¼µ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `include/nekocode/analyzers/cpp_pegtl_analyzer.hpp`
```cpp
// ãƒ¡ãƒ³ãƒå¤‰æ•°æ¤œå‡ºãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
std::vector<MemberVariable> detectMemberVariables(
    const std::string& content,
    LineNumber class_start,
    LineNumber class_end
);
```

### 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ‹¡å¼µ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/core/session_manager.cpp`

#### æ–°è¦ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 
```cpp
// execute_command ãƒ¡ã‚½ãƒƒãƒ‰ã«è¿½åŠ 
} else if (command.substr(0, 7) == "analyze") {
    // analyze [filename] [--deep]
    auto parts = split_command(command);
    std::string filename = parts.size() > 1 ? parts[1] : "";
    bool deep = (parts.size() > 2 && parts[2] == "--deep");
    result = cmd_analyze(session, filename, deep);
}
```

#### cmd_analyze å®Ÿè£…
```cpp
nlohmann::json SessionManager::cmd_analyze(
    const SessionData& session,
    const std::string& filename,
    bool deep) const {
    
    nlohmann::json result;
    result["command"] = "analyze";
    result["mode"] = deep ? "deep" : "basic";
    
    if (!session.is_directory) {
        // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
        return analyzeFile(session.single_file_result, deep);
    }
    
    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆ
    if (filename.empty()) {
        // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µãƒãƒªãƒ¼
        return analyzeDirectory(session.directory_result, deep);
    } else {
        // ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
        for (const auto& file : session.directory_result.files) {
            if (file.file_info.name == filename || 
                file.file_info.path.filename() == filename) {
                return analyzeFile(file, deep);
            }
        }
        result["error"] = "ãƒ•ã‚¡ã‚¤ãƒ« '" + filename + "' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
    }
    
    return result;
}
```

## ğŸ”§ å®Ÿè£…è©³ç´°

### Phase 1: åŸºæœ¬çµ±è¨ˆï¼ˆè»½é‡ç‰ˆï¼‰
```cpp
nlohmann::json analyzeFile(const AnalysisResult& file, bool deep) {
    nlohmann::json result;
    result["file"] = file.file_info.name;
    result["total_lines"] = file.file_info.total_lines;
    
    // ã‚¯ãƒ©ã‚¹åˆ¥çµ±è¨ˆ
    nlohmann::json classes_json = nlohmann::json::array();
    for (const auto& cls : file.classes) {
        nlohmann::json class_json;
        class_json["name"] = cls.name;
        class_json["lines"] = cls.end_line - cls.start_line;
        
        // åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹
        ClassMetrics metrics;
        metrics.member_variable_count = cls.member_variables.size();
        metrics.method_count = cls.methods.size();
        metrics.total_lines = cls.end_line - cls.start_line;
        metrics.responsibility_score = metrics.member_variable_count * metrics.method_count;
        
        class_json["metrics"] = {
            {"member_variables", metrics.member_variable_count},
            {"methods", metrics.method_count},
            {"responsibility_score", metrics.responsibility_score},
            {"lines", metrics.total_lines}
        };
        
        // å¤‰æ•°ãƒªã‚¹ãƒˆï¼ˆåŸºæœ¬æƒ…å ±ã®ã¿ï¼‰
        nlohmann::json vars_json = nlohmann::json::array();
        for (const auto& var : cls.member_variables) {
            vars_json.push_back({
                {"name", var.name},
                {"type", var.type},
                {"line", var.declaration_line}
            });
        }
        class_json["member_variables"] = vars_json;
        
        // åˆ¤å®š
        if (metrics.responsibility_score > 500) {
            class_json["warning"] = "è²¬å‹™ãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™";
        }
        
        classes_json.push_back(class_json);
    }
    
    result["classes"] = classes_json;
    
    // ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã®ã‚µãƒãƒªãƒ¼
    result["summary"] = calculateSummary(file);
    
    if (deep) {
        // Phase 2ã®è©³ç´°è§£æã‚’è¿½åŠ 
        result["deep_analysis"] = performDeepAnalysis(file);
    }
    
    return result;
}
```

### Phase 2: è©³ç´°è§£æï¼ˆ--deepã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```cpp
nlohmann::json performDeepAnalysis(const AnalysisResult& file) {
    nlohmann::json result;
    
    for (const auto& cls : file.classes) {
        nlohmann::json class_analysis;
        
        // 1. å¤‰æ•°ä½¿ç”¨çŠ¶æ³åˆ†æ
        auto variable_usage = analyzeVariableUsage(cls, file.function_calls);
        
        // 2. ãƒ¡ã‚½ãƒƒãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        auto method_groups = groupMethodsBySharedVariables(cls, variable_usage);
        
        // 3. å‡é›†åº¦è¨ˆç®—
        float cohesion = calculateCohesion(cls, variable_usage);
        
        // 4. çµåˆåº¦è¨ˆç®—
        int coupling = calculateCoupling(cls, file);
        
        class_analysis["variable_usage"] = variable_usage;
        class_analysis["method_groups"] = method_groups;
        class_analysis["cohesion"] = cohesion;
        class_analysis["coupling"] = coupling;
        
        // 5. åˆ†å‰²ææ¡ˆ
        if (method_groups.size() > 1 && cohesion < 0.5) {
            class_analysis["split_suggestion"] = generateSplitSuggestion(cls, method_groups);
        }
        
        result[cls.name] = class_analysis;
    }
    
    return result;
}
```

## ğŸ“Š å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

### åŸºæœ¬è§£æå‡ºåŠ›
```json
{
  "command": "analyze",
  "mode": "basic",
  "file": "UICore.cpp",
  "total_lines": 2500,
  "classes": [
    {
      "name": "UICore",
      "lines": 1200,
      "metrics": {
        "member_variables": 25,
        "methods": 45,
        "responsibility_score": 1125,
        "lines": 1200
      },
      "member_variables": [
        {"name": "m_widgets", "type": "vector<Widget*>", "line": 55},
        {"name": "m_theme", "type": "Theme", "line": 56}
      ],
      "warning": "è²¬å‹™ãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
    }
  ],
  "summary": {
    "total_classes": 3,
    "largest_class": "UICore (1200è¡Œ)",
    "highest_responsibility": "UICore (ã‚¹ã‚³ã‚¢: 1125)"
  }
}
```

### è©³ç´°è§£æè¿½åŠ å‡ºåŠ›ï¼ˆ--deepï¼‰
```json
{
  "deep_analysis": {
    "UICore": {
      "variable_usage": {
        "m_widgets": {
          "used_by": ["createWidget", "updateWidget", "removeWidget"],
          "usage_count": 45,
          "usage_percentage": 26.7
        }
      },
      "method_groups": [
        {
          "name": "Widgetç®¡ç†",
          "methods": ["createWidget", "updateWidget", "removeWidget"],
          "shared_variables": ["m_widgets", "m_widgetMap"],
          "cohesion": 0.85
        }
      ],
      "cohesion": 0.45,
      "coupling": 12,
      "split_suggestion": {
        "feasible": true,
        "recommended_splits": [
          {
            "class_name": "UIWidgetManager",
            "methods": ["createWidget", "updateWidget", "removeWidget"],
            "variables": ["m_widgets", "m_widgetMap"]
          }
        ]
      }
    }
  }
}
```

## ğŸš€ å®Ÿè£…é †åº

### Step 1: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆ30åˆ†ï¼‰
1. types.hpp ã« MemberVariable æ§‹é€ ä½“è¿½åŠ 
2. ClassInfo ã« member_variables ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
3. ClassMetrics æ§‹é€ ä½“è¿½åŠ 

### Step 2: C++ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼æ‹¡å¼µï¼ˆ1æ™‚é–“ï¼‰
1. ãƒ¡ãƒ³ãƒå¤‰æ•°æ¤œå‡ºæ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆ
2. detectMemberVariables ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
3. æ—¢å­˜ã® analyze ãƒ¡ã‚½ãƒƒãƒ‰ã§ member_variables ã‚’è¨­å®š

### Step 3: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ï¼ˆ30åˆ†ï¼‰
1. to_json ã§ãƒ¡ãƒ³ãƒå¤‰æ•°æƒ…å ±ã‚’ä¿å­˜
2. from_json ã§ãƒ¡ãƒ³ãƒå¤‰æ•°æƒ…å ±ã‚’å¾©å…ƒ

### Step 4: analyze ã‚³ãƒãƒ³ãƒ‰åŸºæœ¬å®Ÿè£…ï¼ˆ1æ™‚é–“ï¼‰
1. cmd_analyze ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
2. åŸºæœ¬çµ±è¨ˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
3. è²¬å‹™ã‚¹ã‚³ã‚¢ã€è­¦å‘Šåˆ¤å®š

### Step 5: ãƒ†ã‚¹ãƒˆï¼ˆ30åˆ†ï¼‰
1. æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
2. analyze ã‚³ãƒãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
3. å‡ºåŠ›ç¢ºèªãƒ»èª¿æ•´

### Step 6: è©³ç´°è§£æå®Ÿè£…ï¼ˆ2æ™‚é–“ï¼‰- å¾Œæ—¥
1. å¤‰æ•°ä½¿ç”¨çŠ¶æ³åˆ†æ
2. ãƒ¡ã‚½ãƒƒãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
3. å‡é›†åº¦ãƒ»çµåˆåº¦è¨ˆç®—

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¨ˆç”»

```bash
# 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆãƒ¡ãƒ³ãƒå¤‰æ•°æ¤œå‡ºå«ã‚€ï¼‰
./nekocode_ai session-create test-projects/nyamesh-cpp

# 2. åŸºæœ¬è§£æãƒ†ã‚¹ãƒˆ
./nekocode_ai session-cmd <session_id> "analyze"
./nekocode_ai session-cmd <session_id> "analyze UICore.h"

# 3. ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
./nekocode_ai session-cmd <session_id> "analyze nonexistent.cpp"

# 4. è©³ç´°è§£æãƒ†ã‚¹ãƒˆï¼ˆå®Ÿè£…å¾Œï¼‰
./nekocode_ai session-cmd <session_id> "analyze UICore.h --deep"
```

## âš ï¸ æ³¨æ„äº‹é …

1. **å¾Œæ–¹äº’æ›æ€§**: æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: åŸºæœ¬è§£æã¯é«˜é€Ÿã«ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—ï¼‰
3. **è¨€èªå¯¾å¿œ**: ã¾ãšC++ã‹ã‚‰å®Ÿè£…ã€ä»–è¨€èªã¯é †æ¬¡è¿½åŠ 
4. **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: ãƒ•ã‚¡ã‚¤ãƒ«æœªç™ºè¦‹ã€ã‚¯ãƒ©ã‚¹ãªã—ãƒ•ã‚¡ã‚¤ãƒ«ç­‰

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

1. **å®¢è¦³çš„åˆ¤æ–­**: æ•°å€¤åŒ–ã•ã‚ŒãŸè²¬å‹™ã‚¹ã‚³ã‚¢ã§ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°åˆ¤æ–­
2. **é«˜é€Ÿãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: åŸºæœ¬çµ±è¨ˆã¯å³åº§ã«è¡¨ç¤º
3. **æ®µéšçš„åˆ†æ**: å¿…è¦ã«å¿œã˜ã¦è©³ç´°è§£æ
4. **å®Ÿç”¨çš„**: Claude CodeãŒã™ãã«æ´»ç”¨ã§ãã‚‹æƒ…å ±

---
å®Ÿè£…é–‹å§‹: 2025-07-31
ç›®æ¨™å®Œäº†: Phase 1-5ã‚’æœ¬æ—¥ä¸­ã€Phase 6ã¯å¾Œæ—¥