cmake_minimum_required(VERSION 3.16)
project(NekoCodeCpp VERSION 1.0.0 LANGUAGES C CXX)

#=============================================================================
# ğŸ± NekoCode C++ - é«˜é€Ÿè§£æãƒ„ãƒ¼ãƒ«
#
# å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼’å€‹å¤§ä½œæˆ¦ï¼š
# - nekocode_ai: AI/Claudeç”¨JSONå‡ºåŠ›
# - nekocode_human: Humanç”¨ç¾ã—ã„ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›
#
# Pythonç‰ˆã‹ã‚‰ã®å¤§å¹…æ€§èƒ½å‘ä¸Š:
# - 10-100å€é«˜é€ŸåŒ–
# - ä½ãƒ¡ãƒ¢ãƒªæ¶ˆè²»
# - ä¸¦åˆ—å‡¦ç†å¯¾å¿œ
#=============================================================================

# C++17å¿…é ˆ
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# std::regexä½¿ç”¨é˜²æ­¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆé–‹ç™ºè€…å‘ã‘è­¦å‘Šï¼‰
option(NEKOCODE_PREVENT_REGEX "Prevent std::regex usage" ON)
if(NEKOCODE_PREVENT_REGEX)
    add_compile_definitions(NEKOCODE_PREVENT_REGEX)
    message(STATUS "âš ï¸  std::regex prevention enabled - Use PEGTL instead!")
endif()

# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼è­¦å‘Šè¨­å®š
if(MSVC)
    add_compile_options(/W4)
else()
    add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# æœ€é©åŒ–è¨­å®š
if(CMAKE_BUILD_TYPE STREQUAL "Release")
    add_compile_options(-O3 -DNDEBUG)
    message(STATUS "ğŸš€ Release build: æœ€å¤§æœ€é©åŒ–ãƒ¢ãƒ¼ãƒ‰")
elseif(CMAKE_BUILD_TYPE STREQUAL "Debug")
    add_compile_options(-g -DDEBUG)
    message(STATUS "ğŸ› Debug build: ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰")
endif()

if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
    message(STATUS "âš¡ Default: Release build")
endif()

#=============================================================================
# ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
#=============================================================================

set(INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/include)
set(SRC_DIR ${CMAKE_CURRENT_SOURCE_DIR}/src)

# ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ãƒ‘ã‚¹
include_directories(${INCLUDE_DIR})

#=============================================================================
# ğŸ“¦ External Dependencies
#=============================================================================

# nlohmann/json for JSON formatting
find_package(nlohmann_json QUIET)
if(NOT nlohmann_json_FOUND)
    message(STATUS "ğŸ“¦ nlohmann/json not found, using single header")
    include(FetchContent)
    FetchContent_Declare(
        nlohmann_json
        URL https://github.com/nlohmann/json/releases/download/v3.11.2/json.tar.xz
    )
    FetchContent_MakeAvailable(nlohmann_json)
endif()

# UTF8-CPP for Unicode support
message(STATUS "ğŸŒ Fetching UTF8-CPP for Unicode support...")
include(FetchContent)
FetchContent_Declare(
    utf8cpp
    GIT_REPOSITORY https://github.com/nemtrif/utfcpp.git
    GIT_TAG v3.2.4
)
FetchContent_MakeAvailable(utf8cpp)

# ğŸ”¥ PEGTL - è»½é‡é«˜æ€§èƒ½ãƒ‘ãƒ¼ã‚µãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ
message(STATUS "ğŸ”¥ Fetching PEGTL for advanced parsing...")
include(FetchContent)
FetchContent_Declare(
    pegtl
    GIT_REPOSITORY https://github.com/taocpp/PEGTL.git
    GIT_TAG 3.2.7
)
FetchContent_MakeAvailable(pegtl)

# ğŸŒ³ Tree-sitter Phase 3: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼çµ±åˆï¼ˆPEGTLç§»è¡Œäºˆå®šï¼‰
message(STATUS "ğŸŒ³ Tree-sitter placeholder integration (migrating to PEGTL)")

# ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”¨Tree-sitterãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆæš«å®šç¶­æŒï¼‰
add_library(tree-sitter-core STATIC ${SRC_DIR}/legacy/tree_sitter_placeholder.c)
target_include_directories(tree-sitter-core PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/include
)

# è¨€èªçµ±åˆç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
add_library(tree-sitter-langs INTERFACE)

# Threads for parallel processing
find_package(Threads REQUIRED)

#=============================================================================
# ğŸ§  NekoCode Core Library
#=============================================================================

# ğŸ¯ ã‚³ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚½ãƒ¼ã‚¹ï¼ˆæ–°æ§‹é€ å¯¾å¿œï¼‰
set(NEKOCODE_SOURCES
    # Coreæ©Ÿèƒ½
    ${SRC_DIR}/core/core.cpp
    ${SRC_DIR}/core/language_detection.cpp
    ${SRC_DIR}/core/session_manager.cpp
    
    # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
    ${SRC_DIR}/formatters/formatters.cpp
    
    # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    ${SRC_DIR}/utils/utf8_utils.cpp
    ${SRC_DIR}/utils/include_analyzer.cpp
    
    # ãƒ¬ã‚¬ã‚·ãƒ¼ï¼ˆå¿…è¦ã«å¿œã˜ã¦å‰Šé™¤äºˆå®šï¼‰
    ${SRC_DIR}/legacy/tree_sitter_analyzer.cpp
    ${SRC_DIR}/legacy/pegtl_analyzer.cpp
    
    # è¨€èªåˆ¥ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ï¼ˆæ–°æ§‹é€ ï¼‰
    ${SRC_DIR}/analyzers/analyzer_factory.cpp
    ${SRC_DIR}/analyzers/python/python_analyzer.cpp
    ${SRC_DIR}/analyzers/javascript/javascript_analyzer.cpp
    ${SRC_DIR}/analyzers/cpp/cpp_language_analyzer.cpp
    ${SRC_DIR}/analyzers/cpp/cpp_analyzer.cpp
    ${SRC_DIR}/analyzers/csharp/csharp_analyzer.cpp
    ${SRC_DIR}/analyzers/csharp/csharp_pegtl_analyzer.cpp
    ${SRC_DIR}/analyzers/unity/unity_analyzer.cpp
)

# ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«
set(NEKOCODE_HEADERS
    ${INCLUDE_DIR}/nekocode/types.hpp
    ${INCLUDE_DIR}/nekocode/core.hpp
    ${INCLUDE_DIR}/nekocode/tree_sitter_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/pegtl_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/formatters.hpp
    ${INCLUDE_DIR}/nekocode/utf8_utils.hpp
    ${INCLUDE_DIR}/nekocode/language_detection.hpp
    ${INCLUDE_DIR}/nekocode/cpp_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/session_manager.hpp
    ${INCLUDE_DIR}/nekocode/include_analyzer.hpp
    # è¨€èªåˆ¥ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼
    ${INCLUDE_DIR}/nekocode/analyzers/base_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/analyzers/python_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/analyzers/javascript_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/analyzers/cpp_language_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/analyzers/csharp_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/analyzers/unity_analyzer.hpp
    ${INCLUDE_DIR}/nekocode/analyzers/unity_patterns.hpp
    ${INCLUDE_DIR}/nekocode/analyzers/unity_components.hpp
)

# é™çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½œæˆ
add_library(nekocode_static STATIC ${NEKOCODE_SOURCES} ${NEKOCODE_HEADERS})
target_include_directories(nekocode_static PUBLIC 
    ${INCLUDE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/include
)
target_link_libraries(nekocode_static 
    nlohmann_json::nlohmann_json 
    utf8::cpp
    tree-sitter-core
    tree-sitter-langs
    taocpp::pegtl
    Threads::Threads
)

# C++17 features
target_compile_features(nekocode_static PUBLIC cxx_std_17)

#=============================================================================
# ğŸ¤– AI Tool - Claude Codeæœ€é©åŒ–å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
#=============================================================================

add_executable(nekocode_ai ${SRC_DIR}/main/main_ai.cpp)
target_link_libraries(nekocode_ai nekocode_static)

# AIç”¨ç‰¹åˆ¥æœ€é©åŒ–
target_compile_definitions(nekocode_ai PRIVATE 
    NEKOCODE_AI_MODE=1
    NEKOCODE_PERFORMANCE_PRIORITY=1
)

#=============================================================================
# ğŸ‘¨â€ğŸ’» Human Tool - ç¾ã—ã„å‡ºåŠ›å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
#=============================================================================

add_executable(nekocode_human ${SRC_DIR}/main/main_human.cpp)
target_link_libraries(nekocode_human nekocode_static)

# Humanç”¨è¦‹ãŸç›®é‡è¦–
target_compile_definitions(nekocode_human PRIVATE 
    NEKOCODE_HUMAN_MODE=1
    NEKOCODE_VISUAL_PRIORITY=1
)

#=============================================================================
# ğŸ§ª Tests
#=============================================================================

option(BUILD_TESTS "Build test suite" ON)
if(BUILD_TESTS)
    enable_testing()
    
    # ç°¡æ˜“ãƒ†ã‚¹ãƒˆ
    add_executable(test_core ${CMAKE_CURRENT_SOURCE_DIR}/tests/test_core.cpp)
    target_link_libraries(test_core nekocode_static)
    add_test(NAME CoreTest COMMAND test_core)
    
    add_executable(test_performance ${CMAKE_CURRENT_SOURCE_DIR}/tests/test_performance.cpp)
    target_link_libraries(test_performance nekocode_static)
    add_test(NAME PerformanceTest COMMAND test_performance)
endif()

#=============================================================================
# ğŸ“¦ Install Configuration
#=============================================================================

option(ENABLE_INSTALL "Enable install target" ON)
if(ENABLE_INSTALL)
    # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    install(TARGETS nekocode_ai nekocode_human
        RUNTIME DESTINATION bin
    )
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ä½¿ç”¨æ™‚ï¼‰
    install(DIRECTORY ${INCLUDE_DIR}/nekocode
        DESTINATION include
        FILES_MATCHING PATTERN "*.hpp"
    )
    
    # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    install(TARGETS nekocode_static
        ARCHIVE DESTINATION lib
    )
endif()

#=============================================================================
# ğŸ”§ Development Tools
#=============================================================================

# Clang-tidyï¼ˆã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼‰
option(ENABLE_CLANG_TIDY "Enable clang-tidy checks" OFF)
if(ENABLE_CLANG_TIDY)
    find_program(CLANG_TIDY_EXE NAMES "clang-tidy")
    if(CLANG_TIDY_EXE)
        set(CMAKE_CXX_CLANG_TIDY "${CLANG_TIDY_EXE}")
        message(STATUS "âœ… clang-tidy enabled")
    else()
        message(STATUS "âŒ clang-tidy not found")
    endif()
endif()

# Address Sanitizerï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãƒã‚§ãƒƒã‚¯ï¼‰
option(ENABLE_ASAN "Enable AddressSanitizer" OFF)
if(ENABLE_ASAN)
    target_compile_options(nekocode_static PRIVATE -fsanitize=address -fno-omit-frame-pointer)
    target_link_options(nekocode_static PRIVATE -fsanitize=address)
    message(STATUS "ğŸ›¡ï¸ AddressSanitizer enabled")
endif()

# Thread Sanitizerï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯ï¼‰
option(ENABLE_TSAN "Enable ThreadSanitizer" OFF)
if(ENABLE_TSAN)
    target_compile_options(nekocode_static PRIVATE -fsanitize=thread)
    target_link_options(nekocode_static PRIVATE -fsanitize=thread)
    message(STATUS "ğŸ”’ ThreadSanitizer enabled")
endif()

#=============================================================================
# ğŸ“Š Build Summary
#=============================================================================

message(STATUS "")
message(STATUS "ğŸ± NekoCode C++ Build Configuration:")
message(STATUS "   Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "   C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "   Tests: ${BUILD_TESTS}")
message(STATUS "   Install Target: ${ENABLE_INSTALL}")
message(STATUS "")
message(STATUS "ğŸ¯ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼’å€‹å¤§ä½œæˆ¦:")
message(STATUS "   ğŸ¤– nekocode_ai     - AI/Claudeç”¨JSONå‡ºåŠ›")
message(STATUS "   ğŸ‘¨â€ğŸ’» nekocode_human  - Humanç”¨ç¾ã—ã„ãƒ†ã‚­ã‚¹ãƒˆ")
message(STATUS "")
message(STATUS "âš¡ Pythonç‰ˆã‹ã‚‰ã®é©å‘½çš„æ”¹å–„:")
message(STATUS "   ğŸ“ˆ æ€§èƒ½: 10-100å€é«˜é€ŸåŒ–")
message(STATUS "   ğŸ§  ãƒ¡ãƒ¢ãƒª: å¤§å¹…å‰Šæ¸›")
message(STATUS "   ğŸš€ ä¸¦åˆ—: ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œ")
message(STATUS "   ğŸ”’ å‹å®‰å…¨: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ãƒã‚§ãƒƒã‚¯")
message(STATUS "")

#=============================================================================
# ğŸš€ Quick Build Commands
#=============================================================================

# ã‚«ã‚¹ã‚¿ãƒ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ä¸¡æ–¹ãƒ“ãƒ«ãƒ‰
add_custom_target(build_all
    COMMAND ${CMAKE_COMMAND} --build ${CMAKE_BINARY_DIR} --target nekocode_ai --parallel
    COMMAND ${CMAKE_COMMAND} --build ${CMAKE_BINARY_DIR} --target nekocode_human --parallel
    COMMENT "ğŸš€ Build both AI and Human tools"
)

# ã‚«ã‚¹ã‚¿ãƒ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: AIå°‚ç”¨ãƒ“ãƒ«ãƒ‰
add_custom_target(build_ai
    COMMAND ${CMAKE_COMMAND} --build ${CMAKE_BINARY_DIR} --target nekocode_ai --parallel
    COMMENT "ğŸ¤– Build AI tool only"
)

# ã‚«ã‚¹ã‚¿ãƒ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: Humanå°‚ç”¨ãƒ“ãƒ«ãƒ‰
add_custom_target(build_human
    COMMAND ${CMAKE_COMMAND} --build ${CMAKE_BINARY_DIR} --target nekocode_human --parallel
    COMMENT "ğŸ‘¨â€ğŸ’» Build Human tool only"
)

# ã‚«ã‚¹ã‚¿ãƒ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
add_custom_target(run_tests
    COMMAND ${CMAKE_COMMAND} --build ${CMAKE_BINARY_DIR} --target test_core --parallel
    COMMAND ./test_core
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    COMMENT "ğŸ§ª Build and run tests"
)

# ã‚«ã‚¹ã‚¿ãƒ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
add_custom_target(benchmark
    COMMAND ${CMAKE_COMMAND} --build ${CMAKE_BINARY_DIR} --target test_performance --parallel
    COMMAND ./test_performance
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    COMMENT "âš¡ Run performance benchmark"
)